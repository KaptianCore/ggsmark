"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = plugin;

require("core-js");

var C_NEWLINE = '\n';
var C_NEWPARAGRAPH = '\n\n';
/**
 * Match line against an array of token
 * @param {String} token token like '!#'
 * @param {String} value value to check of the token
 */

function matchToken(token, value) {
  return value.trim().startsWith(token);
}
/**
 * Get the color of a block
 * @param {String} token token like '!#'
 * @param {String} colorExpression regular expression to match, it must capture the first group
 * @param {String} block final string block to be parsed
 */


function getBlockColor(token, colorExpression, block) {
  var trimmedBlock = block.trim();

  if (trimmedBlock.startsWith(token)) {
    return trimmedBlock.slice(token.length).match(colorExpression)[1];
  }
}

function plugin() {
  var _options$token, _options$colorExpress;

  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var Parser = this.Parser;
  var blockTokenizers = Parser.prototype.blockTokenizers;
  var blockMethods = Parser.prototype.blockMethods;
  var inlineTokenizers = Parser.prototype.inlineTokenizers;
  var inlineMethods = Parser.prototype.inlineMethods;
  options.token = (_options$token = options.token) !== null && _options$token !== void 0 ? _options$token : '!#';
  options.colorExpression = (_options$colorExpress = options.colorExpression) !== null && _options$colorExpress !== void 0 ? _options$colorExpress : /^\s*(rgba?\(\d{1,3}\s*\,\s*\d{1,3}\s*\,\s*\d{1,3}\s*(\,\s*\d{1,3}\s*)?\)|(\#?[A-z0-9]{3,12}))?/;

  function tokenizeBlocks(eat, value, silent) {
    var match = matchToken(options.token, value);
    if (!match) return;
    if (silent) return true;
    var startBlock,
        endBlock = 0;
    var index,
        newLine = 0;
    var completeBlock = false;
    var firstRun = true;

    do {
      newLine = value.indexOf(C_NEWLINE, index + 1);
      var line = value.substring(index, newLine === -1 ? value.length : newLine);
      var matchedEndToken = matchToken(options.token, line) && !firstRun; // Found a match to end the block

      if (!!matchedEndToken) {
        endBlock = newLine === -1 ? value.length : newLine;
        completeBlock = true;
      }

      index = newLine;
      firstRun = false;
    } while (!completeBlock && newLine !== -1);

    if (!completeBlock) return;
    var block = value.substring(startBlock, endBlock);
    var blockContent = block.substring(block.indexOf(C_NEWLINE), block.lastIndexOf(C_NEWLINE)).trim();
    var color = getBlockColor(options.token, options.colorExpression, block);
    var start = eat.now();
    var add = eat(block);
    var end = eat.now();
    var children = this.tokenizeBlock(blockContent, start);
    return add({
      type: 'colorText',
      children: children,
      data: {
        hName: 'div',
        hProperties: {
          style: "color: ".concat(color)
        }
      },
      position: {
        start,
        end
      }
    });
  }

  function locateInlineToken(value, fromIndex) {
    return value.indexOf(options.token, fromIndex);
  }

  function tokenizeInlines(eat, value, silent) {
    var match = matchToken(options.token, value);
    if (!match) return;
    if (silent) return true;
    var color = getBlockColor(options.token, options.colorExpression, value);
    var openBracket = value.indexOf('(') + 1;
    var closeBracket = value.indexOf(')');
    var inline = value.substring(0, closeBracket + 1);
    var inlineContent = value.substring(openBracket, closeBracket);
    if (openBracket === -1 || closeBracket === -1) return;
    var start = eat.now();
    var add = eat(inline);
    var end = eat.now();
    var children = this.tokenizeInline(inlineContent, start);
    return add({
      type: 'colorText',
      children: children,
      data: {
        hName: 'span',
        hProperties: {
          style: "color: ".concat(color)
        }
      },
      position: {
        start,
        end
      }
    });
  }

  tokenizeInlines.notInLink = true;
  tokenizeInlines.locator = locateInlineToken;
  blockTokenizers.colorText = tokenizeBlocks;
  inlineTokenizers.colorText = tokenizeInlines;
  blockMethods.splice(blockMethods.indexOf('blockquote') + 1, 0, 'colorText');
  inlineMethods.splice(inlineMethods.indexOf('escape') + 1, 0, 'colorText');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJDX05FV0xJTkUiLCJDX05FV1BBUkFHUkFQSCIsIm1hdGNoVG9rZW4iLCJ0b2tlbiIsInZhbHVlIiwidHJpbSIsInN0YXJ0c1dpdGgiLCJnZXRCbG9ja0NvbG9yIiwiY29sb3JFeHByZXNzaW9uIiwiYmxvY2siLCJ0cmltbWVkQmxvY2siLCJzbGljZSIsImxlbmd0aCIsIm1hdGNoIiwicGx1Z2luIiwib3B0aW9ucyIsIlBhcnNlciIsImJsb2NrVG9rZW5pemVycyIsInByb3RvdHlwZSIsImJsb2NrTWV0aG9kcyIsImlubGluZVRva2VuaXplcnMiLCJpbmxpbmVNZXRob2RzIiwidG9rZW5pemVCbG9ja3MiLCJlYXQiLCJzaWxlbnQiLCJzdGFydEJsb2NrIiwiZW5kQmxvY2siLCJpbmRleCIsIm5ld0xpbmUiLCJjb21wbGV0ZUJsb2NrIiwiZmlyc3RSdW4iLCJpbmRleE9mIiwibGluZSIsInN1YnN0cmluZyIsIm1hdGNoZWRFbmRUb2tlbiIsImJsb2NrQ29udGVudCIsImxhc3RJbmRleE9mIiwiY29sb3IiLCJzdGFydCIsIm5vdyIsImFkZCIsImVuZCIsImNoaWxkcmVuIiwidG9rZW5pemVCbG9jayIsInR5cGUiLCJkYXRhIiwiaE5hbWUiLCJoUHJvcGVydGllcyIsInN0eWxlIiwicG9zaXRpb24iLCJsb2NhdGVJbmxpbmVUb2tlbiIsImZyb21JbmRleCIsInRva2VuaXplSW5saW5lcyIsIm9wZW5CcmFja2V0IiwiY2xvc2VCcmFja2V0IiwiaW5saW5lIiwiaW5saW5lQ29udGVudCIsInRva2VuaXplSW5saW5lIiwibm90SW5MaW5rIiwibG9jYXRvciIsImNvbG9yVGV4dCIsInNwbGljZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBLElBQU1BLFNBQVMsR0FBRyxJQUFsQjtBQUNBLElBQU1DLGNBQWMsR0FBRyxNQUF2QjtBQUVBOzs7Ozs7QUFLQSxTQUFTQyxVQUFULENBQW9CQyxLQUFwQixFQUEyQkMs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SyxtQkFBWVgsS0FBWjtBQURNO0FBRlQsT0FIRztBQVNUWSxNQUFBQSxRQUFRLEVBQUU7QUFDUlgsUUFBQUEsS0FEUTtBQUVSRyxRQUFBQTtBQUZRO0FBVEQsS0FBRCxDQUFWO0FBY0Q7O0FBRURXLEVBQUFBLGVBQWUsQ0FBQ00sU0FBaEIsR0FBNEIsSUFBNUI7QUFDQU4sRUFBQUEsZUFBZSxDQUFDTyxPQUFoQixHQUEwQlQsaUJBQTFCO0FBRUFqQyxFQUFBQSxlQUFlLENBQUMyQyxTQUFoQixHQUE0QnRDLGNBQTVCO0FBQ0FGLEVBQUFBLGdCQUFnQixDQUFDd0MsU0FBakIsR0FBNkJSLGVBQTdCO0FBRUFqQyxFQUFBQSxZQUFZLENBQUMwQyxNQUFiLENBQW9CMUMsWUFBWSxDQUFDWSxPQUFiLENBQXFCLFlBQXJCLElBQXFDLENBQXpELEVBQTRELENBQTVELEVBQStELFdBQS9EO0FBQ0FWLEVBQUFBLGFBQWEsQ0FBQ3dDLE1BQWQsQ0FBcUJ4QyxhQUFhLENBQUNVLE9BQWQsQ0FBc0IsUUFBdEIsSUFBa0MsQ0FBdkQsRUFBMEQsQ0FBMUQsRUFBNkQsV0FBN0Q7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCAnY29yZS1qcydcclxuXHJcbmNvbnN0IENfTkVXTElORSA9ICdcXG4nXHJcbmNvbnN0IENfTkVXUEFSQUdSQVBIID0gJ1xcblxcbidcclxuXHJcbi8qKlxyXG4gKiBNYXRjaCBsaW5lIGFnYWluc3QgYW4gYXJyYXkgb2YgdG9rZW5cclxuICogQHBhcmFtIHtTdHJpbmd9IHRva2VuIHRva2VuIGxpa2UgJyEjJ1xyXG4gKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgdmFsdWUgdG8gY2hlY2sgb2YgdGhlIHRva2VuXHJcbiAqL1xyXG5mdW5jdGlvbiBtYXRjaFRva2VuKHRva2VuLCB2YWx1ZSkge1xyXG4gIHJldHVybiB2YWx1ZS50cmltKCkuc3RhcnRzV2l0aCh0b2tlbilcclxufVxyXG5cclxuLyoqXHJcbiAqIEdldCB0aGUgY29sb3Igb2YgYSBibG9ja1xyXG4gKiBAcGFyYW0ge1N0cmluZ30gdG9rZW4gdG9rZW4gbGlrZSAnISMnXHJcbiAqIEBwYXJhbSB7U3RyaW5nfSBjb2xvckV4cHJlc3Npb24gcmVndWxhciBleHByZXNzaW9uIHRvIG1hdGNoLCBpdCBtdXN0IGNhcHR1cmUgdGhlIGZpcnN0IGdyb3VwXHJcbiAqIEBwYXJhbSB7U3RyaW5nfSBibG9jayBmaW5hbCBzdHJpbmcgYmxvY2sgdG8gYmUgcGFyc2VkXHJcbiAqL1xyXG5mdW5jdGlvbiBnZXRCbG9ja0NvbG9yKHRva2VuLCBjb2xvckV4cHJlc3Npb24sIGJsb2NrKSB7XHJcbiAgbGV0IHRyaW1tZWRCbG9jayA9IGJsb2NrLnRyaW0oKVxyXG4gIGlmICh0cmltbWVkQmxvY2suc3RhcnRzV2l0aCh0b2tlbikpIHtcclxuICAgIHJldHVybiB0cmltbWVkQmxvY2suc2xpY2UodG9rZW4ubGVuZ3RoKS5tYXRjaChjb2xvckV4cHJlc3Npb24pWzFdXHJcbiAgfVxyXG59XHJcblxyXG5leHBvcnQgZGVmYXVsdCBmdW5jdGlvbiBwbHVnaW4ob3B0aW9ucyA9IHt9KSB7XHJcbiAgY29uc3QgUGFyc2VyID0gdGhpcy5QYXJzZXJcclxuICBjb25zdCBibG9ja1Rva2VuaXplcnMgPSBQYXJzZXIucHJvdG90eXBlLmJsb2NrVG9rZW5pemVyc1xyXG4gIGNvbnN0IGJsb2NrTWV0aG9kcyA9IFBhcnNlci5wcm90b3R5cGUuYmxvY2tNZXRob2RzXHJcbiAgY29uc3QgaW5saW5lVG9rZW5pemVycyA9IFBhcnNlci5wcm90b3R5cGUuaW5saW5lVG9rZW5pemVyc1xyXG4gIGNvbnN0IGlubGluZU1ldGhvZHMgPSBQYXJzZXIucHJvdG90eXBlLmlubGluZU1ldGhvZHNcclxuXHJcbiAgb3B0aW9ucy50b2tlbiA9IG9wdGlvbnMudG9rZW4gPz8gJyEjJ1xyXG4gIG9wdGlvbnMuY29sb3JFeHByZXNzaW9uID1cclxuICAgIG9wdGlvbnMuY29sb3JFeHByZXNzaW9uID8/XHJcbiAgICAvXlxccyoocmdiYT9cXChcXGR7MSwzfVxccypcXCxcXHMqXFxkezEsM31cXHMqXFwsXFxzKlxcZHsxLDN9XFxzKihcXCxcXHMqXFxkezEsM31cXHMqKT9cXCl8KFxcIz9bQS16MC05XXszLDEyfSkpPy9cclxuXHJcbiAgZnVuY3Rpb24gdG9rZW5pemVCbG9ja3MoZWF0LCB2YWx1ZSwgc2lsZW50KSB7XHJcbiAgICBsZXQgbWF0Y2ggPSBtYXRjaFRva2VuKG9wdGlvbnMudG9rZW4sIHZhbHVlKVxyXG5cclxuICAgIGlmICghbWF0Y2gpIHJldHVyblxyXG5cclxuICAgIGlmIChzaWxlbnQpIHJldHVybiB0cnVlXHJcblxyXG4gICAgbGV0IHN0YXJ0QmxvY2ssXHJcbiAgICAgIGVuZEJsb2NrID0gMFxyXG4gICAgbGV0IGluZGV4LFxyXG4gICAgICBuZXdMaW5lID0gMFxyXG4gICAgbGV0IGNvbXBsZXRlQmxvY2sgPSBmYWxzZVxyXG4gICAgbGV0IGZpcnN0UnVuID0gdHJ1ZVxyXG5cclxuICAgIGRvIHtcclxuICAgICAgbmV3TGluZSA9IHZhbHVlLmluZGV4T2YoQ19ORVdMSU5FLCBpbmRleCArIDEpXHJcblxyXG4gICAgICBsZXQgbGluZSA9IHZhbHVlLnN1YnN0cmluZyhpbmRleCwgbmV3TGluZSA9PT0gLTEgPyB2YWx1ZS5sZW5ndGggOiBuZXdMaW5lKVxyXG4gICAgICBsZXQgbWF0Y2hlZEVuZFRva2VuID0gbWF0Y2hUb2tlbihvcHRpb25zLnRva2VuLCBsaW5lKSAmJiAhZmlyc3RSdW5cclxuXHJcbiAgICAgIC8vIEZvdW5kIGEgbWF0Y2ggdG8gZW5kIHRoZSBibG9ja1xyXG4gICAgICBpZiAoISFtYXRjaGVkRW5kVG9rZW4pIHtcclxuICAgICAgICBlbmRCbG9jayA9IG5ld0xpbmUgPT09IC0xID8gdmFsdWUubGVuZ3RoIDogbmV3TGluZVxyXG4gICAgICAgIGNvbXBsZXRlQmxvY2sgPSB0cnVlXHJcbiAgICAgIH1cclxuXHJcbiAgICAgIGluZGV4ID0gbmV3TGluZVxyXG4gICAgICBmaXJzdFJ1biA9IGZhbHNlXHJcbiAgICB9IHdoaWxlICghY29tcGxldGVCbG9jayAmJiBuZXdMaW5lICE9PSAtMSlcclxuXHJcbiAgICBpZiAoIWNvbXBsZXRlQmxvY2spIHJldHVyblxyXG5cclxuICAgIGxldCBibG9jayA9IHZhbHVlLnN1YnN0cmluZyhzdGFydEJsb2NrLCBlbmRCbG9jaylcclxuICAgIGxldCBibG9ja0NvbnRlbnQgPSBibG9ja1xyXG4gICAgICAuc3Vic3RyaW5nKGJsb2NrLmluZGV4T2YoQ19ORVdMSU5FKSwgYmxvY2subGFzdEluZGV4T2YoQ19ORVdMSU5FKSlcclxuICAgICAgLnRyaW0oKVxyXG5cclxuICAgIGxldCBjb2xvciA9IGdldEJsb2NrQ29sb3Iob3B0aW9ucy50b2tlbiwgb3B0aW9ucy5jb2xvckV4cHJlc3Npb24sIGJsb2NrKVxyXG5cclxuICAgIGNvbnN0IHN0YXJ0ID0gZWF0Lm5vdygpXHJcbiAgICBjb25zdCBhZGQgPSBlYXQoYmxvY2spXHJcbiAgICBjb25zdCBlbmQgPSBlYXQubm93KClcclxuICAgIGNvbnN0IGNoaWxkcmVuID0gdGhpcy50b2tlbml6ZUJsb2NrKGJsb2NrQ29udGVudCwgc3RhcnQpXHJcblxyXG4gICAgcmV0dXJuIGFkZCh7XHJcbiAgICAgIHR5cGU6ICdjb2xvclRleHQnLFxyXG4gICAgICBjaGlsZHJlbjogY2hpbGRyZW4sXHJcbiAgICAgIGRhdGE6IHtcclxuICAgICAgICBoTmFtZTogJ2RpdicsXHJcbiAgICAgICAgaFByb3BlcnRpZXM6IHtcclxuICAgICAgICAgIHN0eWxlOiBgY29sb3I6ICR7Y29sb3J9YFxyXG4gICAgICAgIH1cclxuICAgICAgfSxcclxuICAgICAgcG9zaXRpb246IHtcclxuICAgICAgICBzdGFydCxcclxuICAgICAgICBlbmRcclxuICAgICAgfVxyXG4gICAgfSlcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIGxvY2F0ZUlubGluZVRva2VuKHZhbHVlLCBmcm9tSW5kZXgpIHtcclxuICAgIHJldHVybiB2YWx1ZS5pbmRleE9mKG9wdGlvbnMudG9rZW4sIGZyb21JbmRleClcclxuICB9XHJcblxyXG4gIGZ1bmN0aW9uIHRva2VuaXplSW5saW5lcyhlYXQsIHZhbHVlLCBzaWxlbnQpIHtcclxuICAgIGxldCBtYXRjaCA9IG1hdGNoVG9rZW4ob3B0aW9ucy50b2tlbiwgdmFsdWUpXHJcblxyXG4gICAgaWYgKCFtYXRjaCkgcmV0dXJuXHJcblxyXG4gICAgaWYgKHNpbGVudCkgcmV0dXJuIHRydWVcclxuXHJcbiAgICBsZXQgY29sb3IgPSBnZXRCbG9ja0NvbG9yKG9wdGlvbnMudG9rZW4sIG9wdGlvbnMuY29sb3JFeHByZXNzaW9uLCB2YWx1ZSlcclxuICAgIGxldCBvcGVuQnJhY2tldCA9IHZhbHVlLmluZGV4T2YoJygnKSArIDFcclxuICAgIGxldCBjbG9zZUJyYWNrZXQgPSB2YWx1ZS5pbmRleE9mKCcpJylcclxuICAgIGxldCBpbmxpbmUgPSB2YWx1ZS5zdWJzdHJpbmcoMCwgY2xvc2VCcmFja2V0ICsgMSlcclxuICAgIGxldCBpbmxpbmVDb250ZW50ID0gdmFsdWUuc3Vic3RyaW5nKG9wZW5CcmFja2V0LCBjbG9zZUJyYWNrZXQpXHJcblxyXG4gICAgaWYgKG9wZW5CcmFja2V0ID09PSAtMSB8fCBjbG9zZUJyYWNrZXQgPT09IC0xKSByZXR1cm5cclxuXHJcbiAgICBjb25zdCBzdGFydCA9IGVhdC5ub3coKVxyXG4gICAgY29uc3QgYWRkID0gZWF0KGlubGluZSlcclxuICAgIGNvbnN0IGVuZCA9IGVhdC5ub3coKVxyXG4gICAgY29uc3QgY2hpbGRyZW4gPSB0aGlzLnRva2VuaXplSW5saW5lKGlubGluZUNvbnRlbnQsIHN0YXJ0KVxyXG5cclxuICAgIHJldHVybiBhZGQoe1xyXG4gICAgICB0eXBlOiAnY29sb3JUZXh0JyxcclxuICAgICAgY2hpbGRyZW46IGNoaWxkcmVuLFxyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgaE5hbWU6ICdzcGFuJyxcclxuICAgICAgICBoUHJvcGVydGllczoge1xyXG4gICAgICAgICAgc3R5bGU6IGBjb2xvcjogJHtjb2xvcn1gXHJcbiAgICAgICAgfVxyXG4gICAgICB9LFxyXG4gICAgICBwb3NpdGlvbjoge1xyXG4gICAgICAgIHN0YXJ0LFxyXG4gICAgICAgIGVuZFxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgdG9rZW5pemVJbmxpbmVzLm5vdEluTGluayA9IHRydWVcclxuICB0b2tlbml6ZUlubGluZXMubG9jYXRvciA9IGxvY2F0ZUlubGluZVRva2VuXHJcblxyXG4gIGJsb2NrVG9rZW5pemVycy5jb2xvclRleHQgPSB0b2tlbml6ZUJsb2Nrc1xyXG4gIGlubGluZVRva2VuaXplcnMuY29sb3JUZXh0ID0gdG9rZW5pemVJbmxpbmVzXHJcblxyXG4gIGJsb2NrTWV0aG9kcy5zcGxpY2UoYmxvY2tNZXRob2RzLmluZGV4T2YoJ2Jsb2NrcXVvdGUnKSArIDEsIDAsICdjb2xvclRleHQnKVxyXG4gIGlubGluZU1ldGhvZHMuc3BsaWNlKGlubGluZU1ldGhvZHMuaW5kZXhPZignZXNjYXBlJykgKyAxLCAwLCAnY29sb3JUZXh0JylcclxufVxyXG4iXX0=