"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = plugin;

var _spaceSeparatedTokens = _interopRequireDefault(require("space-separated-tokens"));

require("core-js");

var C_NEWLINE = '\n';
var C_NEWPARAGRAPH = '\n\n';

function plugin() {
  var _options$useClassName;

  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var locateMarker = new RegExp("[^\\\\]?(->|<-)");
  var endMarkers = ['->', '<-'];
  options.classNames = {};
  options.useClassNames = (_options$useClassName = options.useClassNames) !== null && _options$useClassName !== void 0 ? _options$useClassName : false;

  function alignTokenizer(eat, value, silent) {
    var keep = value.match(locateMarker);
    if (!keep || keep.index !== 0) return;
    var now = eat.now();
    var [, startMarker] = keep;
    /* istanbul ignore if - never used (yet) */

    if (silent) return true;
    var index = 0;
    var linesToEat = [];
    var finishedBlocks = [];
    var endMarker = '';
    var canEatLine = true;
    var blockStartIndex = 0;

    while (canEatLine) {
      var nextIndex = value.indexOf(C_NEWLINE, index + 1);
      var lineToEat = nextIndex !== -1 ? value.slice(index, nextIndex) : value.slice(index);
      linesToEat.push(lineToEat);
      var endIndex = endMarkers.indexOf(lineToEat.slice(-2)); // If nextIndex = (blockStartIndex + 2), it's the first marker of the block.

      if ((nextIndex > blockStartIndex + 2 || nextIndex === -1) && lineToEat.length >= 2 && endIndex !== -1) {
        if (endMarker === '') endMarker = lineToEat.slice(-2);
        finishedBlocks.push(linesToEat.join(C_NEWLINE)); // Check if another block is following

        if (value.indexOf('->', nextIndex) !== nextIndex + 1) break;
        linesToEat = [];
        blockStartIndex = nextIndex + 1;
      }

      index = nextIndex + 1;
      canEatLine = nextIndex !== -1;
    }

    var elementType = '';
    var classes, style;

    if (startMarker === '<-' && endMarker === '<-') {
      elementType = 'leftAligned';

      if (options.useClassNames) {
        classes = options.classNames.left ? _spaceSeparatedTokens.default.parse(options.classNames.left) : 'align-left';
      } else {
        style = 'text-align: left';
      }
    }

    if (startMarker === '->') {
      if (endMarker === '<-') {
        elementType = 'centerAligned';

        if (options.useClassNames) {
          classes = options.classNames.center ? _spaceSeparatedTokens.default.parse(options.classNames.center) : 'align-center';
        } else {
          style = 'text-align: center';
        }
      }

      if (endMarker === '->') {
        elementType = 'rightAligned';

        if (options.useClassNames) {
          classes = options.classNames.right ? _spaceSeparatedTokens.default.parse(options.classNames.right) : 'align-right';
        } else {
          style = 'text-align: right';
        }
      }
    }

    if (!elementType) return;
    if (finishedBlocks.length === 0) return;
    var stringToEat = '';
    var marker = finishedBlocks[0].substring(finishedBlocks[0].length - 2, finishedBlocks[0].length);
    var toEat = [];

    for (var i = 0; i < finishedBlocks.length; ++i) {
      var block = finishedBlocks[i];
      if (marker !== block.substring(block.length - 2, block.length)) break;
      toEat.push(block);
      stringToEat += block.slice(2, -2) + C_NEWPARAGRAPH;
    }

    var add = eat(toEat.join(C_NEWLINE));
    var exit = this.enterBlock();
    var values = this.tokenizeBlock(stringToEat, now);
    exit();
    return add({
      type: elementType,
      children: values,
      data: {
        hName: 'div',
        hProperties: {
          class: classes,
          style
        }
      }
    });
  }

  var Parser = this.Parser; // Inject blockTokenizer

  var blockTokenizers = Parser.prototype.blockTokenizers;
  var blockMethods = Parser.prototype.blockMethods;
  blockTokenizers.alignBlocks = alignTokenizer;
  blockMethods.splice(blockMethods.indexOf('list') + 1, 0, 'alignBlocks');
  var Compiler = this.Compiler; // Stringify

  if (Compiler) {
    var visitors = Compiler.prototype.visitors;
    if (!visitors) return;

    var alignCompiler = function alignCompiler(node) {
      var innerContent = this.all(node);
      var markers = {
        left: ['<-', '<-'],
        right: ['->', '->'],
        center: ['->', '<-']
      };
      var alignType = node.type.slice(0, -7);
      if (!markers[alignType]) return innerContent.join('\n\n');
      var [start, end] = markers[alignType];
      if (innerContent.length < 2) return "".concat(start, " ").concat(innerContent.join('\n').trim(), " ").concat(end);
      return "".concat(start, "\n").concat(innerContent.join('\n\n').trim(), "\n").concat(end);
    };

    visitors.leftAligned = alignCompiler;
    visitors.rightAligned = alignCompiler;
    visitors.centerAligned = alignCompiler;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJDX05FV0xJTkUiLCJDX05FV1BBUkFHUkFQSCIsInBsdWdpbiIsIm9wdGlvbnMiLCJsb2NhdGVNYXJrZXIiLCJSZWdFeHAiLCJlbmRNYXJrZXJzIiwiY2xhc3NOYW1lcyIsInVzZUNsYXNzTmFtZXMiLCJhbGlnblRva2VuaXplciIsImVhdCIsInZhbHVlIiwic2lsZW50Iiwia2VlcCIsIm1hdGNoIiwiaW5kZXgiLCJub3ciLCJzdGFydE1hcmtlciIsImxpbmVzVG9FYXQiLCJmaW5pc2hlZEJsb2NrcyIsImVuZE1hcmtlciIsImNhbkVhdExpbmUiLCJibG9ja1N0YXJ0SW5kZXgiLCJuZXh0SW5kZXgiLCJpbmRleE9mIiwibGluZVRvRWF0Iiwic2xpY2UiLCJwdXNoIiwiZW5kSW5kZXgiLCJsZW5ndGgiLCJqb2luIiwiZWxlbWVudFR5cGUiLCJjbGFzc2VzIiwic3R5bGUiLCJsZWZ0Iiwic3BhY2VTZXBhcmF0ZWQiLCJwYXJzZSIsImNlbnRlciIsInJpZ2h0Iiwic3RyaW5nVG9FYXQiLCJtYXJrZXIiLCJzdWJzdHJpbmciLCJ0b0VhdCIsImkiLCJibG9jayIsImFkZCIsImV4aXQiLCJlbnRlckJsb2NrIiwidmFsdWVzIiwidG9rZW5pemVCbG9jayIsInR5cGUiLCJjaGlsZHJlbiIsImRhdGEiLCJoTmFtZSIsImhQcm9wZXJ0aWVzIiwiY2xhc3MiLCJQYXJzZXIiLCJibG9ja1Rva2VuaXplcnMiLCJwcm90b3R5cGUiLCJibG9ja01ldGhvZHMiLCJhbGlnbkJsb2NrcyIsInNwbGljZSIsIkNvbXBpbGVyIiwidmlzaXRvcnMiLCJhbGlnbkNvbXBpbGVyIiwibm9kZSIsImlubmVyQ29udGVudCIsImFsbCIsIm1hcmtlcnMiLCJhbGlnblR5cGUiLCJzdGFydCIsImVuZCIsInRyaW0iLCJsZWZ0QWxpZ25lZCIsInJpZ2h0QWxpZ25lZCIsImNlbnRlckFsaWduZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7OztBQUFBOztB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QUFsQjtBQUVBLFVBQUksQ0FBQzBDLE9BQU8sQ0FBQ0MsU0FBRCxDQUFaLEVBQXlCLE9BQU9ILFlBQVksQ0FBQ3BDLElBQWIsQ0FBa0IsTUFBbEIsQ0FBUDtBQUV6QixVQUFNLENBQUN3QyxLQUFELEVBQVFDLEdBQVIsSUFBZUgsT0FBTyxDQUFDQyxTQUFELENBQTVCO0FBRUEsVUFBSUgsWUFBWSxDQUFDckMsTUFBYixHQUFzQixDQUExQixFQUNFLGlCQUFVeUMsS0FBVixjQUFtQkosWUFBWSxDQUFDcEMsSUFBYixDQUFrQixJQUFsQixFQUF3QjBDLElBQXhCLEVBQW5CLGNBQXFERCxHQUFyRDtBQUVGLHVCQUFVRCxLQUFWLGVBQW9CSixZQUFZLENBQUNwQyxJQUFiLENBQWtCLE1BQWxCLEVBQTBCMEMsSUFBMUIsRUFBcEIsZUFBeURELEdBQXpEO0FBQ0QsS0FsQkQ7O0FBb0JBUixJQUFBQSxRQUFRLENBQUNVLFdBQVQsR0FBdUJULGFBQXZCO0FBQ0FELElBQUFBLFFBQVEsQ0FBQ1csWUFBVCxHQUF3QlYsYUFBeEI7QUFDQUQsSUFBQUEsUUFBUSxDQUFDWSxhQUFULEdBQXlCWCxhQUF6QjtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgc3BhY2VTZXBhcmF0ZWQgZnJvbSAnc3BhY2Utc2VwYXJhdGVkLXRva2VucydcclxuaW1wb3J0ICdjb3JlLWpzJ1xyXG5cclxuY29uc3QgQ19ORVdMSU5FID0gJ1xcbidcclxuY29uc3QgQ19ORVdQQVJBR1JBUEggPSAnXFxuXFxuJ1xyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcGx1Z2luKG9wdGlvbnMgPSB7fSkge1xyXG4gIGNvbnN0IGxvY2F0ZU1hcmtlciA9IG5ldyBSZWdFeHAoYFteXFxcXFxcXFxdPygtPnw8LSlgKVxyXG4gIGNvbnN0IGVuZE1hcmtlcnMgPSBbJy0+JywgJzwtJ11cclxuICBvcHRpb25zLmNsYXNzTmFtZXMgPSB7fVxyXG4gIG9wdGlvbnMudXNlQ2xhc3NOYW1lcyA9IG9wdGlvbnMudXNlQ2xhc3NOYW1lcyA/PyBmYWxzZVxyXG5cclxuICBmdW5jdGlvbiBhbGlnblRva2VuaXplcihlYXQsIHZhbHVlLCBzaWxlbnQpIHtcclxuICAgIGNvbnN0IGtlZXAgPSB2YWx1ZS5tYXRjaChsb2NhdGVNYXJrZXIpXHJcbiAgICBpZiAoIWtlZXAgfHwga2VlcC5pbmRleCAhPT0gMCkgcmV0dXJuXHJcblxyXG4gICAgY29uc3Qgbm93ID0gZWF0Lm5vdygpXHJcbiAgICBjb25zdCBbLCBzdGFydE1hcmtlcl0gPSBrZWVwXHJcblxyXG4gICAgLyogaXN0YW5idWwgaWdub3JlIGlmIC0gbmV2ZXIgdXNlZCAoeWV0KSAqL1xyXG4gICAgaWYgKHNpbGVudCkgcmV0dXJuIHRydWVcclxuXHJcbiAgICBsZXQgaW5kZXggPSAwXHJcbiAgICBsZXQgbGluZXNUb0VhdCA9IFtdXHJcbiAgICBjb25zdCBmaW5pc2hlZEJsb2NrcyA9IFtdXHJcbiAgICBsZXQgZW5kTWFya2VyID0gJydcclxuICAgIGxldCBjYW5FYXRMaW5lID0gdHJ1ZVxyXG4gICAgbGV0IGJsb2NrU3RhcnRJbmRleCA9IDBcclxuXHJcbiAgICB3aGlsZSAoY2FuRWF0TGluZSkge1xyXG4gICAgICBjb25zdCBuZXh0SW5kZXggPSB2YWx1ZS5pbmRleE9mKENfTkVXTElORSwgaW5kZXggKyAxKVxyXG4gICAgICBjb25zdCBsaW5lVG9FYXQgPVxyXG4gICAgICAgIG5leHRJbmRleCAhPT0gLTEgPyB2YWx1ZS5zbGljZShpbmRleCwgbmV4dEluZGV4KSA6IHZhbHVlLnNsaWNlKGluZGV4KVxyXG5cclxuICAgICAgbGluZXNUb0VhdC5wdXNoKGxpbmVUb0VhdClcclxuXHJcbiAgICAgIGNvbnN0IGVuZEluZGV4ID0gZW5kTWFya2Vycy5pbmRleE9mKGxpbmVUb0VhdC5zbGljZSgtMikpXHJcblxyXG4gICAgICAvLyBJZiBuZXh0SW5kZXggPSAoYmxvY2tTdGFydEluZGV4ICsgMiksIGl0J3MgdGhlIGZpcnN0IG1hcmtlciBvZiB0aGUgYmxvY2suXHJcbiAgICAgIGlmIChcclxuICAgICAgICAobmV4dEluZGV4ID4gYmxvY2tTdGFydEluZGV4ICsgMiB8fCBuZXh0SW5kZXggPT09IC0xKSAmJlxyXG4gICAgICAgIGxpbmVUb0VhdC5sZW5ndGggPj0gMiAmJlxyXG4gICAgICAgIGVuZEluZGV4ICE9PSAtMVxyXG4gICAgICApIHtcclxuICAgICAgICBpZiAoZW5kTWFya2VyID09PSAnJykgZW5kTWFya2VyID0gbGluZVRvRWF0LnNsaWNlKC0yKVxyXG5cclxuICAgICAgICBmaW5pc2hlZEJsb2Nrcy5wdXNoKGxpbmVzVG9FYXQuam9pbihDX05FV0xJTkUpKVxyXG5cclxuICAgICAgICAvLyBDaGVjayBpZiBhbm90aGVyIGJsb2NrIGlzIGZvbGxvd2luZ1xyXG4gICAgICAgIGlmICh2YWx1ZS5pbmRleE9mKCctPicsIG5leHRJbmRleCkgIT09IG5leHRJbmRleCArIDEpIGJyZWFrXHJcbiAgICAgICAgbGluZXNUb0VhdCA9IFtdXHJcbiAgICAgICAgYmxvY2tTdGFydEluZGV4ID0gbmV4dEluZGV4ICsgMVxyXG4gICAgICB9XHJcblxyXG4gICAgICBpbmRleCA9IG5leHRJbmRleCArIDFcclxuICAgICAgY2FuRWF0TGluZSA9IG5leHRJbmRleCAhPT0gLTFcclxuICAgIH1cclxuXHJcbiAgICBsZXQgZWxlbWVudFR5cGUgPSAnJ1xyXG4gICAgbGV0IGNsYXNzZXMsIHN0eWxlXHJcblxyXG4gICAgaWYgKHN0YXJ0TWFya2VyID09PSAnPC0nICYmIGVuZE1hcmtlciA9PT0gJzwtJykge1xyXG4gICAgICBlbGVtZW50VHlwZSA9ICdsZWZ0QWxpZ25lZCdcclxuXHJcbiAgICAgIGlmIChvcHRpb25zLnVzZUNsYXNzTmFtZXMpIHtcclxuICAgICAgICBjbGFzc2VzID0gb3B0aW9ucy5jbGFzc05hbWVzLmxlZnRcclxuICAgICAgICAgID8gc3BhY2VTZXBhcmF0ZWQucGFyc2Uob3B0aW9ucy5jbGFzc05hbWVzLmxlZnQpXHJcbiAgICAgICAgICA6ICdhbGlnbi1sZWZ0J1xyXG4gICAgICB9IGVsc2Uge1xyXG4gICAgICAgIHN0eWxlID0gJ3RleHQtYWxpZ246IGxlZnQnXHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoc3RhcnRNYXJrZXIgPT09ICctPicpIHtcclxuICAgICAgaWYgKGVuZE1hcmtlciA9PT0gJzwtJykge1xyXG4gICAgICAgIGVsZW1lbnRUeXBlID0gJ2NlbnRlckFsaWduZWQnXHJcblxyXG4gICAgICAgIGlmIChvcHRpb25zLnVzZUNsYXNzTmFtZXMpIHtcclxuICAgICAgICAgIGNsYXNzZXMgPSBvcHRpb25zLmNsYXNzTmFtZXMuY2VudGVyXHJcbiAgICAgICAgICAgID8gc3BhY2VTZXBhcmF0ZWQucGFyc2Uob3B0aW9ucy5jbGFzc05hbWVzLmNlbnRlcilcclxuICAgICAgICAgICAgOiAnYWxpZ24tY2VudGVyJ1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBzdHlsZSA9ICd0ZXh0LWFsaWduOiBjZW50ZXInXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICAgIGlmIChlbmRNYXJrZXIgPT09ICctPicpIHtcclxuICAgICAgICBlbGVtZW50VHlwZSA9ICdyaWdodEFsaWduZWQnXHJcblxyXG4gICAgICAgIGlmIChvcHRpb25zLnVzZUNsYXNzTmFtZXMpIHtcclxuICAgICAgICAgIGNsYXNzZXMgPSBvcHRpb25zLmNsYXNzTmFtZXMucmlnaHRcclxuICAgICAgICAgICAgPyBzcGFjZVNlcGFyYXRlZC5wYXJzZShvcHRpb25zLmNsYXNzTmFtZXMucmlnaHQpXHJcbiAgICAgICAgICAgIDogJ2FsaWduLXJpZ2h0J1xyXG4gICAgICAgIH0gZWxzZSB7XHJcbiAgICAgICAgICBzdHlsZSA9ICd0ZXh0LWFsaWduOiByaWdodCdcclxuICAgICAgICB9XHJcbiAgICAgIH1cclxuICAgIH1cclxuXHJcbiAgICBpZiAoIWVsZW1lbnRUeXBlKSByZXR1cm5cclxuICAgIGlmIChmaW5pc2hlZEJsb2Nrcy5sZW5ndGggPT09IDApIHJldHVyblxyXG5cclxuICAgIGxldCBzdHJpbmdUb0VhdCA9ICcnXHJcbiAgICBjb25zdCBtYXJrZXIgPSBmaW5pc2hlZEJsb2Nrc1swXS5zdWJzdHJpbmcoXHJcbiAgICAgIGZpbmlzaGVkQmxvY2tzWzBdLmxlbmd0aCAtIDIsXHJcbiAgICAgIGZpbmlzaGVkQmxvY2tzWzBdLmxlbmd0aFxyXG4gICAgKVxyXG4gICAgY29uc3QgdG9FYXQgPSBbXVxyXG4gICAgZm9yIChsZXQgaSA9IDA7IGkgPCBmaW5pc2hlZEJsb2Nrcy5sZW5ndGg7ICsraSkge1xyXG4gICAgICBjb25zdCBibG9jayA9IGZpbmlzaGVkQmxvY2tzW2ldXHJcbiAgICAgIGlmIChtYXJrZXIgIT09IGJsb2NrLnN1YnN0cmluZyhibG9jay5sZW5ndGggLSAyLCBibG9jay5sZW5ndGgpKSBicmVha1xyXG4gICAgICB0b0VhdC5wdXNoKGJsb2NrKVxyXG4gICAgICBzdHJpbmdUb0VhdCArPSBibG9jay5zbGljZSgyLCAtMikgKyBDX05FV1BBUkFHUkFQSFxyXG4gICAgfVxyXG5cclxuICAgIGNvbnN0IGFkZCA9IGVhdCh0b0VhdC5qb2luKENfTkVXTElORSkpXHJcbiAgICBjb25zdCBleGl0ID0gdGhpcy5lbnRlckJsb2NrKClcclxuICAgIGNvbnN0IHZhbHVlcyA9IHRoaXMudG9rZW5pemVCbG9jayhzdHJpbmdUb0VhdCwgbm93KVxyXG4gICAgZXhpdCgpXHJcblxyXG4gICAgcmV0dXJuIGFkZCh7XHJcbiAgICAgIHR5cGU6IGVsZW1lbnRUeXBlLFxyXG4gICAgICBjaGlsZHJlbjogdmFsdWVzLFxyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgaE5hbWU6ICdkaXYnLFxyXG4gICAgICAgIGhQcm9wZXJ0aWVzOiB7XHJcbiAgICAgICAgICBjbGFzczogY2xhc3NlcyxcclxuICAgICAgICAgIHN0eWxlXHJcbiAgICAgICAgfVxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgY29uc3QgUGFyc2VyID0gdGhpcy5QYXJzZXJcclxuXHJcbiAgLy8gSW5qZWN0IGJsb2NrVG9rZW5pemVyXHJcbiAgY29uc3QgYmxvY2tUb2tlbml6ZXJzID0gUGFyc2VyLnByb3RvdHlwZS5ibG9ja1Rva2VuaXplcnNcclxuICBjb25zdCBibG9ja01ldGhvZHMgPSBQYXJzZXIucHJvdG90eXBlLmJsb2NrTWV0aG9kc1xyXG4gIGJsb2NrVG9rZW5pemVycy5hbGlnbkJsb2NrcyA9IGFsaWduVG9rZW5pemVyXHJcbiAgYmxvY2tNZXRob2RzLnNwbGljZShibG9ja01ldGhvZHMuaW5kZXhPZignbGlzdCcpICsgMSwgMCwgJ2FsaWduQmxvY2tzJylcclxuXHJcbiAgY29uc3QgQ29tcGlsZXIgPSB0aGlzLkNvbXBpbGVyXHJcblxyXG4gIC8vIFN0cmluZ2lmeVxyXG4gIGlmIChDb21waWxlcikge1xyXG4gICAgY29uc3QgdmlzaXRvcnMgPSBDb21waWxlci5wcm90b3R5cGUudmlzaXRvcnNcclxuICAgIGlmICghdmlzaXRvcnMpIHJldHVyblxyXG5cclxuICAgIGNvbnN0IGFsaWduQ29tcGlsZXIgPSBmdW5jdGlvbiAobm9kZSkge1xyXG4gICAgICBjb25zdCBpbm5lckNvbnRlbnQgPSB0aGlzLmFsbChub2RlKVxyXG5cclxuICAgICAgY29uc3QgbWFya2VycyA9IHtcclxuICAgICAgICBsZWZ0OiBbJzwtJywgJzwtJ10sXHJcbiAgICAgICAgcmlnaHQ6IFsnLT4nLCAnLT4nXSxcclxuICAgICAgICBjZW50ZXI6IFsnLT4nLCAnPC0nXVxyXG4gICAgICB9XHJcbiAgICAgIGNvbnN0IGFsaWduVHlwZSA9IG5vZGUudHlwZS5zbGljZSgwLCAtNylcclxuXHJcbiAgICAgIGlmICghbWFya2Vyc1thbGlnblR5cGVdKSByZXR1cm4gaW5uZXJDb250ZW50LmpvaW4oJ1xcblxcbicpXHJcblxyXG4gICAgICBjb25zdCBbc3RhcnQsIGVuZF0gPSBtYXJrZXJzW2FsaWduVHlwZV1cclxuXHJcbiAgICAgIGlmIChpbm5lckNvbnRlbnQubGVuZ3RoIDwgMilcclxuICAgICAgICByZXR1cm4gYCR7c3RhcnR9ICR7aW5uZXJDb250ZW50LmpvaW4oJ1xcbicpLnRyaW0oKX0gJHtlbmR9YFxyXG5cclxuICAgICAgcmV0dXJuIGAke3N0YXJ0fVxcbiR7aW5uZXJDb250ZW50LmpvaW4oJ1xcblxcbicpLnRyaW0oKX1cXG4ke2VuZH1gXHJcbiAgICB9XHJcblxyXG4gICAgdmlzaXRvcnMubGVmdEFsaWduZWQgPSBhbGlnbkNvbXBpbGVyXHJcbiAgICB2aXNpdG9ycy5yaWdodEFsaWduZWQgPSBhbGlnbkNvbXBpbGVyXHJcbiAgICB2aXNpdG9ycy5jZW50ZXJBbGlnbmVkID0gYWxpZ25Db21waWxlclxyXG4gIH1cclxufVxyXG4iXX0=