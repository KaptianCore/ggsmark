"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = plugin;

require("core-js");

var C_NEWLINE = '\n';
var C_NEWPARAGRAPH = '\n\n';
/**
 * Match line against an array of token
 * @param {String} token token like '!#'
 * @param {String} value value to check of the token
 */

function matchToken(token, value) {
  return value.trim().startsWith(token);
}

function plugin() {
  var _options$defaultSumma, _options$token, _options$detailsClass, _options$summaryClass;

  var options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};
  var Parser = this.Parser;
  var blockTokenizers = Parser.prototype.blockTokenizers;
  var blockMethods = Parser.prototype.blockMethods;
  var inlineTokenizers = Parser.prototype.inlineTokenizers;
  var inlineMethods = Parser.prototype.inlineMethods;
  options.defaultSummary = (_options$defaultSumma = options.defaultSummary) !== null && _options$defaultSumma !== void 0 ? _options$defaultSumma : 'Open spoiler';
  options.token = (_options$token = options.token) !== null && _options$token !== void 0 ? _options$token : '!spoiler';
  options.detailsClassName = (_options$detailsClass = options.detailsClassName) !== null && _options$detailsClass !== void 0 ? _options$detailsClass : '';
  options.summaryClassName = (_options$summaryClass = options.summaryClassName) !== null && _options$summaryClass !== void 0 ? _options$summaryClass : '';

  function tokenizeBlocks(eat, value, silent) {
    var match = matchToken(options.token, value);
    if (!match) return;
    if (silent) return true;
    var startBlock,
        endBlock = 0;
    var index,
        newLine = 0;
    var completeBlock = false;
    var firstRun = true;

    do {
      newLine = value.indexOf(C_NEWLINE, index + 1);
      var line = value.substring(index, newLine === -1 ? value.length : newLine);
      var matchedEndToken = matchToken(options.token, line) && !firstRun; // Found a match to end the block

      if (!!matchedEndToken) {
        endBlock = newLine === -1 ? value.length : newLine;
        completeBlock = true;
      }

      index = newLine;
      firstRun = false;
    } while (!completeBlock && newLine !== -1);

    if (!completeBlock) return;
    var block = value.substring(startBlock, endBlock);
    var blockContent = block.substring(block.indexOf(C_NEWLINE), block.lastIndexOf(C_NEWLINE)).trim();
    var summary = block.slice(options.token.length, block.indexOf(C_NEWLINE)).trim();
    var start = eat.now();
    var add = eat(block);
    var end = eat.now();
    var children = [];
    var childrenBlockContent = this.tokenizeBlock(blockContent, start);

    if (summary !== '') {
      children.push({
        type: 'summary',
        data: {
          hName: 'summary'
        },
        children: [{
          type: 'text',
          value: summary
        }]
      });
    }

    children = [...children, ...childrenBlockContent];
    return add({
      type: 'spoiler',
      children: children,
      data: {
        hName: 'details'
      },
      position: {
        start,
        end
      }
    });
  }

  blockTokenizers.spoiler = tokenizeBlocks;
  blockMethods.splice(blockMethods.indexOf('blockquote') + 1, 0, 'spoiler');
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uL3NyYy9pbmRleC5qcyJdLCJuYW1lcyI6WyJDX05FV0xJTkUiLCJDX05FV1BBUkFHUkFQSCIsIm1hdGNoVG9rZW4iLCJ0b2tlbiIsInZhbHVlIiwidHJpbSIsInN0YXJ0c1dpdGgiLCJwbHVnaW4iLCJvcHRpb25zIiwiUGFyc2VyIiwiYmxvY2tUb2tlbml6ZXJzIiwicHJvdG90eXBlIiwiYmxvY2tNZXRob2RzIiwiaW5saW5lVG9rZW5pemVycyIsImlubGluZU1ldGhvZHMiLCJkZWZhdWx0U3VtbWFyeSIsImRldGFpbHNDbGFzc05hbWUiLCJzdW1tYXJ5Q2xhc3NOYW1lIiwidG9rZW5pemVCbG9ja3MiLCJlYXQiLCJzaWxlbnQiLCJtYXRjaCIsInN0YXJ0QmxvY2siLCJlbmRCbG9jayIsImluZGV4IiwibmV3TGluZSIsImNvbXBsZXRlQmxvY2siLCJmaXJzdFJ1biIsImluZGV4T2YiLCJsaW5lIiwic3Vic3RyaW5nIiwibGVuZ3RoIiwibWF0Y2hlZEVuZFRva2VuIiwiYmxvY2siLCJibG9ja0NvbnRlbnQiLCJsYXN0SW5kZXhPZiIsInN1bW1hcnkiLCJzbGljZSIsInN0YXJ0Iiwibm93IiwiYWRkIiwiZW5kIiwiY2hpbGRyZW4iLCJjaGlsZHJlbkJsb2NrQ29udGVudCIsInRva2VuaXplQmxvY2siLCJwdXNoIiwidHlwZSIsImRhdGEiLCJoTmFtZSIsInBvc2l0aW9uIiwic3BvaWxlciIsInNwbGljZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUVBLElBQU1BLFNBQVMsR0FBRyxJQUFsQjtBQUNBLElBQU1DLGNBQWMsR0FBRyxNQUF2QjtBQUVBOzs7Ozs7QUFLQSxTQUFTQyxVQUFULENBQW9CQyxLQUFwQixFQUEyQkMsS0FBM0IsRUFBa0M7QUFDaEMsU0FBT0EsS0FBSyxDQUFDQyxJQUFOLEdBQWFDLFVBQWIsQ0FBd0JILEtBQXhCLENBQVA7QUFDRDs7QUFFYyxTQUFTSSxNQUFULEdBQThCO0FBQUE7O0FBQUEsTUFBZEMsT0FBYyx1RUFBSixF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b250ZW50IjpbImltcG9ydCAnY29yZS1qcydcclxuXHJcbmNvbnN0IENfTkVXTElORSA9ICdcXG4nXHJcbmNvbnN0IENfTkVXUEFSQUdSQVBIID0gJ1xcblxcbidcclxuXHJcbi8qKlxyXG4gKiBNYXRjaCBsaW5lIGFnYWluc3QgYW4gYXJyYXkgb2YgdG9rZW5cclxuICogQHBhcmFtIHtTdHJpbmd9IHRva2VuIHRva2VuIGxpa2UgJyEjJ1xyXG4gKiBAcGFyYW0ge1N0cmluZ30gdmFsdWUgdmFsdWUgdG8gY2hlY2sgb2YgdGhlIHRva2VuXHJcbiAqL1xyXG5mdW5jdGlvbiBtYXRjaFRva2VuKHRva2VuLCB2YWx1ZSkge1xyXG4gIHJldHVybiB2YWx1ZS50cmltKCkuc3RhcnRzV2l0aCh0b2tlbilcclxufVxyXG5cclxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcGx1Z2luKG9wdGlvbnMgPSB7fSkge1xyXG4gIGNvbnN0IFBhcnNlciA9IHRoaXMuUGFyc2VyXHJcbiAgY29uc3QgYmxvY2tUb2tlbml6ZXJzID0gUGFyc2VyLnByb3RvdHlwZS5ibG9ja1Rva2VuaXplcnNcclxuICBjb25zdCBibG9ja01ldGhvZHMgPSBQYXJzZXIucHJvdG90eXBlLmJsb2NrTWV0aG9kc1xyXG4gIGNvbnN0IGlubGluZVRva2VuaXplcnMgPSBQYXJzZXIucHJvdG90eXBlLmlubGluZVRva2VuaXplcnNcclxuICBjb25zdCBpbmxpbmVNZXRob2RzID0gUGFyc2VyLnByb3RvdHlwZS5pbmxpbmVNZXRob2RzXHJcblxyXG4gIG9wdGlvbnMuZGVmYXVsdFN1bW1hcnkgPSBvcHRpb25zLmRlZmF1bHRTdW1tYXJ5ID8/ICdPcGVuIHNwb2lsZXInXHJcbiAgb3B0aW9ucy50b2tlbiA9IG9wdGlvbnMudG9rZW4gPz8gJyFzcG9pbGVyJ1xyXG4gIG9wdGlvbnMuZGV0YWlsc0NsYXNzTmFtZSA9IG9wdGlvbnMuZGV0YWlsc0NsYXNzTmFtZSA/PyAnJ1xyXG4gIG9wdGlvbnMuc3VtbWFyeUNsYXNzTmFtZSA9IG9wdGlvbnMuc3VtbWFyeUNsYXNzTmFtZSA/PyAnJ1xyXG5cclxuICBmdW5jdGlvbiB0b2tlbml6ZUJsb2NrcyhlYXQsIHZhbHVlLCBzaWxlbnQpIHtcclxuICAgIGxldCBtYXRjaCA9IG1hdGNoVG9rZW4ob3B0aW9ucy50b2tlbiwgdmFsdWUpXHJcblxyXG4gICAgaWYgKCFtYXRjaCkgcmV0dXJuXHJcblxyXG4gICAgaWYgKHNpbGVudCkgcmV0dXJuIHRydWVcclxuXHJcbiAgICBsZXQgc3RhcnRCbG9jayxcclxuICAgICAgZW5kQmxvY2sgPSAwXHJcbiAgICBsZXQgaW5kZXgsXHJcbiAgICAgIG5ld0xpbmUgPSAwXHJcbiAgICBsZXQgY29tcGxldGVCbG9jayA9IGZhbHNlXHJcbiAgICBsZXQgZmlyc3RSdW4gPSB0cnVlXHJcblxyXG4gICAgZG8ge1xyXG4gICAgICBuZXdMaW5lID0gdmFsdWUuaW5kZXhPZihDX05FV0xJTkUsIGluZGV4ICsgMSlcclxuXHJcbiAgICAgIGxldCBsaW5lID0gdmFsdWUuc3Vic3RyaW5nKGluZGV4LCBuZXdMaW5lID09PSAtMSA/IHZhbHVlLmxlbmd0aCA6IG5ld0xpbmUpXHJcbiAgICAgIGxldCBtYXRjaGVkRW5kVG9rZW4gPSBtYXRjaFRva2VuKG9wdGlvbnMudG9rZW4sIGxpbmUpICYmICFmaXJzdFJ1blxyXG5cclxuICAgICAgLy8gRm91bmQgYSBtYXRjaCB0byBlbmQgdGhlIGJsb2NrXHJcbiAgICAgIGlmICghIW1hdGNoZWRFbmRUb2tlbikge1xyXG4gICAgICAgIGVuZEJsb2NrID0gbmV3TGluZSA9PT0gLTEgPyB2YWx1ZS5sZW5ndGggOiBuZXdMaW5lXHJcbiAgICAgICAgY29tcGxldGVCbG9jayA9IHRydWVcclxuICAgICAgfVxyXG5cclxuICAgICAgaW5kZXggPSBuZXdMaW5lXHJcbiAgICAgIGZpcnN0UnVuID0gZmFsc2VcclxuICAgIH0gd2hpbGUgKCFjb21wbGV0ZUJsb2NrICYmIG5ld0xpbmUgIT09IC0xKVxyXG5cclxuICAgIGlmICghY29tcGxldGVCbG9jaykgcmV0dXJuXHJcblxyXG4gICAgbGV0IGJsb2NrID0gdmFsdWUuc3Vic3RyaW5nKHN0YXJ0QmxvY2ssIGVuZEJsb2NrKVxyXG4gICAgbGV0IGJsb2NrQ29udGVudCA9IGJsb2NrXHJcbiAgICAgIC5zdWJzdHJpbmcoYmxvY2suaW5kZXhPZihDX05FV0xJTkUpLCBibG9jay5sYXN0SW5kZXhPZihDX05FV0xJTkUpKVxyXG4gICAgICAudHJpbSgpXHJcbiAgICBsZXQgc3VtbWFyeSA9IGJsb2NrXHJcbiAgICAgIC5zbGljZShvcHRpb25zLnRva2VuLmxlbmd0aCwgYmxvY2suaW5kZXhPZihDX05FV0xJTkUpKVxyXG4gICAgICAudHJpbSgpXHJcblxyXG4gICAgY29uc3Qgc3RhcnQgPSBlYXQubm93KClcclxuICAgIGNvbnN0IGFkZCA9IGVhdChibG9jaylcclxuICAgIGNvbnN0IGVuZCA9IGVhdC5ub3coKVxyXG4gICAgbGV0IGNoaWxkcmVuID0gW11cclxuICAgIGxldCBjaGlsZHJlbkJsb2NrQ29udGVudCA9IHRoaXMudG9rZW5pemVCbG9jayhibG9ja0NvbnRlbnQsIHN0YXJ0KVxyXG5cclxuICAgIGlmIChzdW1tYXJ5ICE9PSAnJykge1xyXG4gICAgICBjaGlsZHJlbi5wdXNoKHtcclxuICAgICAgICB0eXBlOiAnc3VtbWFyeScsXHJcbiAgICAgICAgZGF0YToge1xyXG4gICAgICAgICAgaE5hbWU6ICdzdW1tYXJ5J1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY2hpbGRyZW46IFtcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgdHlwZTogJ3RleHQnLFxyXG4gICAgICAgICAgICB2YWx1ZTogc3VtbWFyeVxyXG4gICAgICAgICAgfVxyXG4gICAgICAgIF1cclxuICAgICAgfSlcclxuICAgIH1cclxuXHJcbiAgICBjaGlsZHJlbiA9IFsuLi5jaGlsZHJlbiwgLi4uY2hpbGRyZW5CbG9ja0NvbnRlbnRdXHJcblxyXG4gICAgcmV0dXJuIGFkZCh7XHJcbiAgICAgIHR5cGU6ICdzcG9pbGVyJyxcclxuICAgICAgY2hpbGRyZW46IGNoaWxkcmVuLFxyXG4gICAgICBkYXRhOiB7XHJcbiAgICAgICAgaE5hbWU6ICdkZXRhaWxzJ1xyXG4gICAgICB9LFxyXG4gICAgICBwb3NpdGlvbjoge1xyXG4gICAgICAgIHN0YXJ0LFxyXG4gICAgICAgIGVuZFxyXG4gICAgICB9XHJcbiAgICB9KVxyXG4gIH1cclxuXHJcbiAgYmxvY2tUb2tlbml6ZXJzLnNwb2lsZXIgPSB0b2tlbml6ZUJsb2Nrc1xyXG5cclxuICBibG9ja01ldGhvZHMuc3BsaWNlKGJsb2NrTWV0aG9kcy5pbmRleE9mKCdibG9ja3F1b3RlJykgKyAxLCAwLCAnc3BvaWxlcicpXHJcbn1cclxuIl19